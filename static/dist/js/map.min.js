/*
 pogomap 2016-11-13 
*/

"use strict";function excludePokemon(a){$selectExclude.val($selectExclude.val().concat(a)).trigger("change")}function notifyAboutPokemon(a){$selectPokemonNotify.val($selectPokemonNotify.val().concat(a)).trigger("change")}function removePokemonMarker(a){mapData.pokemons[a].marker.rangeCircle&&(mapData.pokemons[a].marker.rangeCircle.setMap(null),delete mapData.pokemons[a].marker.rangeCircle),mapData.pokemons[a].marker.setMap(null),mapData.pokemons[a].hidden=!0}function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:centerLat,lng:centerLng},zoom:Store.get("zoomLevel"),fullscreenControl:!0,streetViewControl:!1,mapTypeControl:!1,clickableIcons:!1,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,position:google.maps.ControlPosition.RIGHT_TOP,mapTypeIds:[google.maps.MapTypeId.ROADMAP,google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.HYBRID,"nolabels_style","dark_style","style_light2","style_pgo","dark_style_nl","style_light2_nl","style_pgo_nl"]}});var a=new google.maps.StyledMapType(noLabelsStyle,{name:"No Labels"});map.mapTypes.set("nolabels_style",a);var b=new google.maps.StyledMapType(darkStyle,{name:"Dark"});map.mapTypes.set("dark_style",b);var c=new google.maps.StyledMapType(light2Style,{name:"Light2"});map.mapTypes.set("style_light2",c);var d=new google.maps.StyledMapType(pGoStyle,{name:"PokemonGo"});map.mapTypes.set("style_pgo",d);var e=new google.maps.StyledMapType(darkStyleNoLabels,{name:"Dark (No Labels)"});map.mapTypes.set("dark_style_nl",e);var f=new google.maps.StyledMapType(light2StyleNoLabels,{name:"Light2 (No Labels)"});map.mapTypes.set("style_light2_nl",f);var g=new google.maps.StyledMapType(pGoStyleNoLabels,{name:"PokemonGo (No Labels)"});map.mapTypes.set("style_pgo_nl",g),map.addListener("maptypeid_changed",function(a){Store.set("map_style",this.mapTypeId)}),map.setMapTypeId(Store.get("map_style")),map.addListener("idle",updateMap),map.addListener("zoom_changed",function(){storeZoom===!0?Store.set("zoomLevel",this.getZoom()):storeZoom=!0,redrawPokemon(mapData.pokemons),redrawPokemon(mapData.lurePokemons)}),searchMarker=createSearchMarker(),locationMarker=createLocationMarker(),createMyLocationButton(),initSidebar(),$("#scan-here").on("click",function(){var a=map.getCenter();changeLocation(a.lat(),a.lng()),$("#search-switch").checked||($("#search-switch").prop("checked",!0),searchControl("on"))})}function updateLocationMarker(a){return a in searchMarkerStyles&&(locationMarker.setIcon(searchMarkerStyles[a].icon),Store.set("locationMarkerStyle",a)),locationMarker}function createLocationMarker(){var a=Store.get("followMyLocationPosition"),b="lat"in a?a.lat:centerLat,c="lng"in a?a.lng:centerLng,d=new google.maps.Marker({map:map,animation:google.maps.Animation.DROP,position:{lat:b,lng:c},draggable:!0,icon:null,optimized:!1,zIndex:google.maps.Marker.MAX_ZINDEX+2});return d.infoWindow=new google.maps.InfoWindow({content:"<div><b>My Location</b></div>",disableAutoPan:!0}),addListeners(d),google.maps.event.addListener(d,"dragend",function(){var a=d.getPosition();Store.set("followMyLocationPosition",{lat:a.lat(),lng:a.lng()})}),d}function updateSearchMarker(a){return a in searchMarkerStyles&&(searchMarker.setIcon(searchMarkerStyles[a].icon),Store.set("searchMarkerStyle",a)),searchMarker}function createSearchMarker(){var a=new google.maps.Marker({position:{lat:centerLat,lng:centerLng},map:map,animation:google.maps.Animation.DROP,draggable:!Store.get("lockMarker"),icon:null,optimized:!1,zIndex:google.maps.Marker.MAX_ZINDEX+1});a.infoWindow=new google.maps.InfoWindow({content:"<div><b>Search Location</b></div>",disableAutoPan:!0}),addListeners(a);var b=null;return google.maps.event.addListener(a,"dragstart",function(){b=a.getPosition()}),google.maps.event.addListener(a,"dragend",function(){var c=a.getPosition();changeSearchLocation(c.lat(),c.lng()).done(function(){b=null}).fail(function(){b&&a.setPosition(b)})}),a}function searchControl(a){$.post(searchControlURI+"?action="+encodeURIComponent(a)),$("#scan-here").toggleClass("disabled","off"===a)}function updateSearchStatus(){$.getJSON(searchControlURI).then(function(a){$("#search-switch").prop("checked",a.status),$("#scan-here").toggleClass("disabled",!a.status)})}function initSidebar(){$("#gyms-switch").prop("checked",Store.get("showGyms")),$("#pokemon-switch").prop("checked",Store.get("showPokemon")),$("#pokestops-switch").prop("checked",Store.get("showPokestops")),$("#lured-pokestops-only-switch").val(Store.get("showLuredPokestopsOnly")),$("#lured-pokestops-only-wrapper").toggle(Store.get("showPokestops")),$("#geoloc-switch").prop("checked",Store.get("geoLocate")),$("#lock-marker-switch").prop("checked",Store.get("lockMarker")),$("#start-at-user-location-switch").prop("checked",Store.get("startAtUserLocation")),$("#follow-my-location-switch").prop("checked",Store.get("followMyLocation")),$("#scan-here-switch").prop("checked",Store.get("scanHere")),$("#scan-here").toggle(Store.get("scanHere")),$("#scanned-switch").prop("checked",Store.get("showScanned")),$("#spawnpoints-switch").prop("checked",Store.get("showSpawnpoints")),$("#ranges-switch").prop("checked",Store.get("showRanges")),$("#sound-switch").prop("checked",Store.get("playSound"));var a=new google.maps.places.SearchBox(document.getElementById("next-location"));$("#next-location").css("background-color",$("#geoloc-switch").prop("checked")?"#e0e0e0":"#ffffff"),updateSearchStatus(),setInterval(updateSearchStatus,5e3),a.addListener("places_changed",function(){var b=a.getPlaces();if(0!==b.length){var c=b[0].geometry.location;changeLocation(c.lat(),c.lng())}});var b=$("#pokemon-icons");$.each(pokemonSprites,function(a,c){b.append($("<option></option>").attr("value",a).text(c.name))}),b.val(pokemonSprites[Store.get("pokemonIcons")]?Store.get("pokemonIcons"):"highres"),$("#pokemon-icon-size").val(Store.get("iconSizeModifier"))}function pad(a){return a<=99?("0"+a).slice(-2):a}function getTypeSpan(a){return"<span style='padding: 2px 5px; text-transform: uppercase; color: white; margin-right: 2px; border-radius: 4px; font-size: 0.8em; vertical-align: text-bottom; background-color: "+a.color+"'>"+a.type+"</span>"}function openMapDirections(a,b){var c=locationMarker.getPosition(),d="https://www.google.com/maps/dir/"+c.lat()+","+c.lng()+"/"+a+","+b;window.open(d,"_blank")}function pokemonLabel(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=new Date(d),p=b?"("+b+")":"",q="";$.each(c,function(a,b){q+=getTypeSpan(b)});var r="";if(null!=i){var s=(i+j+k)/45*100;r="\n      <div>\n        IV: "+s.toFixed(1)+"% ("+i+"/"+j+"/"+k+")\n      </div>\n      <div>\n        Moves: "+i8ln(moves[l].name)+" / "+i8ln(moves[m].name)+"\n      </div>\n      "}var t="";1===n?t='<div><span style="font-weight: bold; color: #3bb345">This time is secure. It has been received from the server.</span><br>\n    Disappears at '+pad(o.getHours())+":"+pad(o.getMinutes())+":"+pad(o.getSeconds())+"\n    <span class='label-countdown' disappears-at='"+d+"'>(00m00s)</span>\n    </div>":0===n?t='<div><span style="font-weight: bold; color: #bfbc27">This time is only a prediction. It may be wrong.</span><br>\n    Disappears at '+pad(o.getHours())+":"+pad(o.getMinutes())+":"+pad(o.getSeconds())+"\n    <span class='label-countdown' disappears-at='"+d+"'>(00m00s)</span>\n    </div>":n===-1&&(t='<div><span style="font-weight: bold; color: #f1504e">Don\'t trust this time! It has been set manually to<br>15m when this pokemon has been encountered</span><br>\n    Disappears at '+pad(o.getHours())+":"+pad(o.getMinutes())+":"+pad(o.getSeconds())+"\n    <span class='label-countdown' disappears-at='"+d+"'>(00m00s)</span>\n    </div>");var u="\n    <div>\n      <b>"+a+"</b>\n      <span> - </span>\n      <small>\n        <a href='http://www.pokemon.com/us/pokedex/"+e+"' target='_blank' title='View in Pokedex'>#"+e+"</a>\n      </small>\n      <span> "+p+"</span>\n      <span> - </span>\n      <small>"+q+"</small>\n    </div>"+t+("\n    <div>\n      Location: "+f.toFixed(6)+", "+g.toFixed(7)+"\n    </div>\n      "+r+"\n    <div>\n      <a href='javascript:excludePokemon("+e+")'>Exclude</a>&nbsp;&nbsp\n      <a href='javascript:notifyAboutPokemon("+e+")'>Notify</a>&nbsp;&nbsp\n      <a href='javascript:removePokemonMarker(\""+h+"\")'>Remove</a>&nbsp;&nbsp\n      <a href='javascript:void(0);' onclick='javascript:openMapDirections("+f+","+g+");' title='View in Maps'>Get directions</a>\n    </div>");return u}function gymLabel(a,b,c,d,e){for(var f=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,g=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:[],i="",j=0;j<h.length;j++)i+='\n      <span class="gym-member" title="'+h[j].pokemon_name+" | "+h[j].trainer_name+" (Lvl "+h[j].trainer_level+')">\n        <i class="pokemon-sprite n'+h[j].pokemon_id+'"></i>\n        <span class="cp team-'+b+'">'+h[j].pokemon_cp+"</span>\n      </span>";var k;if(f){var l=new Date(f);k=l.getFullYear()+"-"+pad(l.getMonth()+1)+"-"+pad(l.getDate())+" "+pad(l.getHours())+":"+pad(l.getMinutes())+":"+pad(l.getSeconds())}else k="Unknown";var m=g?"<div>"+g+"</div>":"",n=["0, 0, 0, .4","74, 138, 202, .6","240, 68, 58, .6","254, 217, 40, .6"],o;if(0===b)o="\n      <div>\n        <center>\n          <div>\n            <b style='color:rgba("+n[b]+")'>"+a+"</b><br>\n            <img height='70px' style='padding: 5px;' src='static/forts/"+a+"_large.png'>\n          </div>\n          "+m+"\n          <div>\n            Location: "+d.toFixed(6)+", "+e.toFixed(7)+"\n          </div>\n          <div>\n            Last Scanned: "+k+"\n          </div>\n          <div>\n            <a href='javascript:void(0);' onclick='javascript:openMapDirections("+d+","+e+");' title='View in Maps'>Get directions</a>\n          </div>\n        </center>\n      </div>";else{var p=getGymLevel(c);o="\n      <div>\n        <center>\n          <div style='padding-bottom: 2px'>\n            Gym owned by:\n          </div>\n          <div>\n            <b style='color:rgba("+n[b]+")'>Team "+a+"</b><br>\n            <img height='70px' style='padding: 5px;' src='static/forts/"+a+"_large.png'>\n          </div>\n          <div>\n            "+m+"\n          </div>\n          <div>\n            Level: "+p+" | Prestige: "+c+"/"+(gymPrestige[p-1]||5e4)+"\n          </div>\n          <div>\n            "+i+"\n          </div>\n          <div>\n            Location: "+d.toFixed(6)+", "+e.toFixed(7)+"\n          </div>\n          <div>\n            Last Scanned: "+k+"\n          </div>\n          <div>\n            <a href='javascript:void(0);' onclick='javascript:openMapDirections("+d+","+e+");' title='View in Maps'>Get directions</a>\n          </div>\n        </center>\n      </div>"}return o}function getGymLevel(a){for(var b=1;a>=gymPrestige[b-1];)b++;return b}function pokestopLabel(a,b,c){var d;if(a){var e=new Date(a);d="\n      <div>\n        <b>Lured Pokéstop</b>\n      </div>\n      <div>\n        Lure expires at "+pad(e.getHours())+":"+pad(e.getMinutes())+":"+pad(e.getSeconds())+"\n        <span class='label-countdown' disappears-at='"+a+"'>(00m00s)</span>\n      </div>\n      <div>\n        Location: "+b.toFixed(6)+", "+c.toFixed(7)+"\n      </div>\n      <div>\n        <a href='javascript:void(0);' onclick='javascript:openMapDirections("+b+","+c+");' title='View in Maps'>Get directions</a>\n      </div>"}else d="\n      <div>\n        <b>Pokéstop</b>\n      </div>\n      <div>\n        Location: "+b.toFixed(6)+", "+c.toFixed(7)+"\n      </div>\n      <div>\n        <a href='javascript:void(0);' onclick='javascript:openMapDirections("+b+","+c+");' title='View in Maps'>Get directions</a>\n      </div>";return d}function formatSpawnTime(a){return("0"+Math.floor((a+3600)%3600/60)).substr(-2)+":"+("0"+a%60).substr(-2)}function spawnpointLabel(a){var b="\n    <div>\n      <b>Spawn Point</b>\n    </div>\n    <div>\n      Every hour from "+formatSpawnTime(a.time)+" to "+formatSpawnTime(a.time+900)+"\n    </div>";return a.special&&(b+="\n      <div>\n        May appear as early as "+formatSpawnTime(a.time-1800)+"\n      </div>"),b}function addRangeCircle(a,b,c,d){var e=null,f=new google.maps.LatLng(a.position.lat(),a.position.lng()),g=["#999999","#0051CF","#FF260E","#FECC23"],h=g[0];d&&(h=g[d]);var i,j;switch(c){case"pokemon":j="#C233F2",i=40;break;case"pokestop":j="#3EB0FF",i=40;break;case"gym":j=h,i=40}b&&(e=b);var k={map:e,radius:i,strokeWeight:1,strokeColor:j,strokeOpacity:.9,center:f,fillColor:j,fillOpacity:.3},l=new google.maps.Circle(k);return l}function isRangeActive(a){return!(a.getZoom()<16)&&Store.get("showRanges")}function customizePokemonMarker(a,b,c){if(a.addListener("click",function(){this.setAnimation(null),this.animationDisabled=!0}),!a.rangeCircle&&isRangeActive(map)&&(a.rangeCircle=addRangeCircle(a,map,"pokemon")),a.infoWindow=new google.maps.InfoWindow({content:pokemonLabel(b.pokemon_name,b.pokemon_rarity,b.pokemon_types,b.disappear_time,b.pokemon_id,b.latitude,b.longitude,b.encounter_id,b.individual_attack,b.individual_defense,b.individual_stamina,b.move_1,b.move_2,b.time_detail),disableAutoPan:!0}),(notifiedPokemon.indexOf(b.pokemon_id)>-1||notifiedRarity.indexOf(b.pokemon_rarity)>-1)&&(c||(Store.get("playSound")&&audio.play(),sendNotification("A wild "+b.pokemon_name+" appeared!","Click to load map","static/icons/"+b.pokemon_id+".png",b.latitude,b.longitude)),a.animationDisabled!==!0&&a.setAnimation(google.maps.Animation.BOUNCE)),null!=b.individual_attack){var d=100*(b.individual_attack+b.individual_defense+b.individual_stamina)/45;notifiedMinPerfection>0&&d>=notifiedMinPerfection&&(c||(Store.get("playSound")&&audio.play(),sendNotification("A "+d.toFixed(1)+"% perfect "+b.pokemon_name+" appeared!","Click to load map","static/icons/"+b.pokemon_id+".png",b.latitude,b.longitude)),a.animationDisabled!==!0&&a.setAnimation(google.maps.Animation.BOUNCE))}addListeners(a)}function setupGymMarker(a){var b=new google.maps.Marker({position:{lat:a.latitude,lng:a.longitude},map:map,icon:{url:"static/forts/"+Store.get("gymMarkerStyle")+"/"+gymTypes[a.team_id]+(0!==a.team_id?"_"+getGymLevel(a.gym_points):"")+".png",scaledSize:new google.maps.Size(48,48)}});return!b.rangeCircle&&isRangeActive(map)&&(b.rangeCircle=addRangeCircle(b,map,"gym",a.team_id)),b.infoWindow=new google.maps.InfoWindow({content:gymLabel(gymTypes[a.team_id],a.team_id,a.gym_points,a.latitude,a.longitude,a.last_scanned,a.name,a.pokemon),disableAutoPan:!0}),addListeners(b),b}function updateGymMarker(a,b){return b.setIcon({url:"static/forts/"+Store.get("gymMarkerStyle")+"/"+gymTypes[a.team_id]+(0!==a.team_id?"_"+getGymLevel(a.gym_points):"")+".png",scaledSize:new google.maps.Size(48,48)}),b.infoWindow.setContent(gymLabel(gymTypes[a.team_id],a.team_id,a.gym_points,a.latitude,a.longitude,a.last_scanned,a.name,a.pokemon)),b}function updateGymIcons(){$.each(mapData.gyms,function(a,b){mapData.gyms[a].marker.setIcon({url:"static/forts/"+Store.get("gymMarkerStyle")+"/"+gymTypes[mapData.gyms[a].team_id]+(0!==mapData.gyms[a].team_id?"_"+getGymLevel(mapData.gyms[a].gym_points):"")+".png",scaledSize:new google.maps.Size(48,48)})})}function setupPokestopMarker(a){var b=a.lure_expiration?"PstopLured":"Pstop",c=new google.maps.Marker({position:{lat:a.latitude,lng:a.longitude},map:map,zIndex:2,icon:"static/forts/"+b+".png"});return!c.rangeCircle&&isRangeActive(map)&&(c.rangeCircle=addRangeCircle(c,map,"pokestop")),c.infoWindow=new google.maps.InfoWindow({content:pokestopLabel(a.lure_expiration,a.latitude,a.longitude),disableAutoPan:!0}),addListeners(c),c}function getColorByDate(a){var b=(Date.now()-a)/1e3/60/15;b>1&&(b=1);var c=(120*(1-b)).toString(10);return["hsl(",c,",100%,50%)"].join("")}function setupScannedMarker(a){var b=new google.maps.LatLng(a.latitude,a.longitude),c=new google.maps.Circle({map:map,clickable:!1,center:b,radius:70,fillColor:getColorByDate(a.last_modified),fillOpacity:.1,strokeWeight:1,strokeOpacity:.5});return c}function getColorBySpawnTime(a){var b=new Date,c=60*b.getMinutes()+b.getSeconds();c<900&&a>2700?c+=3600:c>2700&&a<900&&(a+=3600);var d=c-a,e=275;return d>=0&&d<=900?e=120*(1-d/60/15):d<0&&d>-300&&(e=50*(1- -d/60/5)+200),e=5*Math.round(e/5)}function changeSpawnIcon(a,b){var c="";c=275===a?"./static/icons/hsl-275-light.png":"./static/icons/hsl-"+a+".png";var d=1.6,e=1,f=Math.round(d*(b-10));f<e&&(f=e);var g={url:c,scaledSize:new google.maps.Size(f,f),anchor:new google.maps.Point(f/2,f/2)};return g}function spawnPointIndex(a){var b=1,c=0;return a>=0&&a<=120?(c=a/120,b=100+100*c):a>=200&&a<=250&&(c=(a-200)/50,b=100*c),b}function setupSpawnpointMarker(a){var b=new google.maps.LatLng(a.latitude,a.longitude),c=getColorBySpawnTime(a.time),d=map.getZoom(),e=new google.maps.Marker({map:map,position:b,icon:changeSpawnIcon(c,d),zIndex:spawnPointIndex(c)});return e.infoWindow=new google.maps.InfoWindow({content:spawnpointLabel(a),disableAutoPan:!0,position:b}),addListeners(e),e}function clearSelection(){document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()}function addListeners(a){return a.addListener("click",function(){a.infoWindowIsOpen?(a.persist=null,a.infoWindow.close(),a.infoWindowIsOpen=!1):(a.infoWindow.open(map,a),clearSelection(),updateLabelDiffTime(),a.persist=!0,a.infoWindowIsOpen=!0)}),google.maps.event.addListener(a.infoWindow,"closeclick",function(){a.persist=null}),a.addListener("mouseover",function(){a.infoWindow.open(map,a),clearSelection(),updateLabelDiffTime()}),a.addListener("mouseout",function(){a.persist||a.infoWindow.close()}),a}function clearStaleMarkers(){$.each(mapData.pokemons,function(a,b){(mapData.pokemons[a].disappear_time<(new Date).getTime()||excludedPokemon.indexOf(mapData.pokemons[a].pokemon_id)>=0)&&(mapData.pokemons[a].marker.rangeCircle&&(mapData.pokemons[a].marker.rangeCircle.setMap(null),delete mapData.pokemons[a].marker.rangeCircle),mapData.pokemons[a].marker.setMap(null),delete mapData.pokemons[a])}),$.each(mapData.lurePokemons,function(a,b){(mapData.lurePokemons[a].lure_expiration<(new Date).getTime()||excludedPokemon.indexOf(mapData.lurePokemons[a].pokemon_id)>=0)&&(mapData.lurePokemons[a].marker.setMap(null),delete mapData.lurePokemons[a])}),$.each(mapData.scanned,function(a,b){mapData.scanned[a].last_modified<(new Date).getTime()-9e5&&(mapData.scanned[a].marker.setMap(null),delete mapData.scanned[a])})}function showInBoundsMarkers(a,b){$.each(a,function(c,d){var e=a[c].marker,f=!1;a[c].hidden||("function"==typeof e.getBounds?map.getBounds().intersects(e.getBounds())&&(f=!0):"function"==typeof e.getPosition&&map.getBounds().contains(e.getPosition())&&(f=!0)),f&&rangeMarkers.indexOf(b)!==-1&&(e.rangeCircle?isRangeActive(map)?e.rangeCircle.setMap(map):e.rangeCircle.setMap(null):isRangeActive(map)&&("gym"===b?e.rangeCircle=addRangeCircle(e,map,b,a[c].team_id):e.rangeCircle=addRangeCircle(e,map,b))),f&&!e.getMap()?(e.setMap(map),e.setAnimation&&e.oldAnimation&&e.setAnimation(e.oldAnimation)):!f&&e.getMap()&&(e.getAnimation&&(e.oldAnimation=e.getAnimation()),e.rangeCircle&&e.rangeCircle.setMap(null),e.setMap(null))})}function loadRawData(){var a=Store.get("showPokemon"),b=Store.get("showGyms"),c=Store.get("showPokestops"),d=Store.get("showScanned"),e=Store.get("showSpawnpoints"),f=Boolean(Store.get("showLuredPokestopsOnly")),g=map.getBounds(),h=g.getSouthWest(),i=g.getNorthEast(),j=h.lat(),k=h.lng(),l=i.lat(),m=i.lng();return $.ajax({url:"raw_data",type:"GET",data:{timestamp:timestamp,pokemon:a,lastpokemon:lastpokemon,pokestops:c,lastpokestops:lastpokestops,luredonly:f,gyms:b,lastgyms:lastgyms,scanned:d,lastslocs:lastslocs,spawnpoints:e,lastspawns:lastspawns,swLat:j,swLng:k,neLat:l,neLng:m,oSwLat:oSwLat,oSwLng:oSwLng,oNeLat:oNeLat,oNeLng:oNeLng,reids:String(reincludedPokemon),eids:String(excludedPokemon)},dataType:"json",cache:!1,beforeSend:function a(){return!rawDataIsLoading&&void(rawDataIsLoading=!0)},complete:function a(){rawDataIsLoading=!1}})}function processPokemons(a,b){return!!Store.get("showPokemon")&&void(!(b.encounter_id in mapData.pokemons)&&excludedPokemon.indexOf(b.pokemon_id)<0&&b.disappear_time>Date.now()&&(b.marker&&b.marker.setMap(null),b.hidden||(b.marker=setupPokemonMarker(b,map),customizePokemonMarker(b.marker,b),mapData.pokemons[b.encounter_id]=b)))}function processPokestops(a,b){if(!Store.get("showPokestops"))return!1;if(Store.get("showLuredPokestopsOnly")&&!b.lure_expiration)return!0;if(mapData.pokestops[b.pokestop_id]){var c=mapData.pokestops[b.pokestop_id];!!b.lure_expiration!=!!c.lure_expiration&&(c.marker&&c.marker.rangeCircle&&c.marker.rangeCircle.setMap(null),c.marker.setMap(null),b.marker=setupPokestopMarker(b),mapData.pokestops[b.pokestop_id]=b)}else b.marker&&b.marker.rangeCircle&&b.marker.rangeCircle.setMap(null),b.marker&&b.marker.setMap(null),b.marker=setupPokestopMarker(b),mapData.pokestops[b.pokestop_id]=b}function updatePokestops(){if(!Store.get("showPokestops"))return!1;var a=[],b=(new Date).getTime();$.each(mapData.pokestops,function(a,c){c.lure_expiration&&c.lure_expiration<b&&(c.lure_expiration=null,c.marker&&c.marker.rangeCircle&&c.marker.rangeCircle.setMap(null),c.marker.setMap(null),c.marker=setupPokestopMarker(c))}),Store.get("showLuredPokestopsOnly")&&($.each(mapData.pokestops,function(b,c){c.lure_expiration||a.push(b)}),$.each(a,function(a,b){mapData.pokestops[b]&&mapData.pokestops[b].marker&&(mapData.pokestops[b].marker.rangeCircle&&mapData.pokestops[b].marker.rangeCircle.setMap(null),mapData.pokestops[b].marker.setMap(null),delete mapData.pokestops[b])}))}function processGyms(a,b){return!!Store.get("showGyms")&&(b.gym_id in mapData.gyms?b.marker=updateGymMarker(b,mapData.gyms[b.gym_id].marker):b.marker=setupGymMarker(b),void(mapData.gyms[b.gym_id]=b))}function processScanned(a,b){if(!Store.get("showScanned"))return!1;var c=b.latitude+"|"+b.longitude;c in mapData.scanned?mapData.scanned[c].last_modified=b.last_modified:(b.marker&&b.marker.setMap(null),b.marker=setupScannedMarker(b),mapData.scanned[c]=b)}function updateScanned(){return!!Store.get("showScanned")&&void $.each(mapData.scanned,function(a,b){map.getBounds().intersects(b.marker.getBounds())&&b.marker.setOptions({fillColor:getColorByDate(b.last_modified)})})}function processSpawnpoints(a,b){if(!Store.get("showSpawnpoints"))return!1;var c=b.spawnpoint_id;c in mapData.spawnpoints||(b.marker&&b.marker.setMap(null),b.marker=setupSpawnpointMarker(b),mapData.spawnpoints[c]=b)}function updateSpawnPoints(){if(!Store.get("showSpawnpoints"))return!1;var a=map.getZoom();$.each(mapData.spawnpoints,function(b,c){if(map.getBounds().contains(c.marker.getPosition())){var d=getColorBySpawnTime(c.time);c.marker.setIcon(changeSpawnIcon(d,a)),c.marker.setZIndex(spawnPointIndex(d))}})}function updateMap(){loadRawData().done(function(a){$.each(a.pokemons,processPokemons),$.each(a.pokestops,processPokestops),$.each(a.gyms,processGyms),$.each(a.scanned,processScanned),$.each(a.spawnpoints,processSpawnpoints),showInBoundsMarkers(mapData.pokemons,"pokemon"),showInBoundsMarkers(mapData.lurePokemons,"pokemon"),showInBoundsMarkers(mapData.gyms,"gym"),showInBoundsMarkers(mapData.pokestops,"pokestop"),showInBoundsMarkers(mapData.scanned,"scanned"),showInBoundsMarkers(mapData.spawnpoints,"inbound"),clearStaleMarkers(),updateScanned(),updateSpawnPoints(),updatePokestops(),$("#stats").hasClass("visible")&&countMarkers(map),oSwLat=a.oSwLat,oSwLng=a.oSwLng,oNeLat=a.oNeLat,oNeLng=a.oNeLng,lastgyms=a.lastgyms,lastpokestops=a.lastpokestops,lastpokemon=a.lastpokemon,lastslocs=a.lastslocs,lastspawns=a.lastspawns,reids=a.reids,reids instanceof Array&&(reincludedPokemon=reids.filter(function(a){return this.indexOf(a)<0},reincludedPokemon)),timestamp=a.timestamp,lastUpdateTime=Date.now()})}function drawScanPath(a){var b=[];$.each(a,function(a,c){b.push({lat:c.latitude,lng:c.longitude})}),scanPath&&scanPath.setMap(null),scanPath=new google.maps.Polyline({path:b,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2,map:map})}function redrawPokemon(a){var b=!0;$.each(a,function(c,d){var e=a[c];if(!e.hidden){e.marker.rangeCircle&&e.marker.rangeCircle.setMap(null);var f=setupPokemonMarker(e,map,this.marker.animationDisabled);customizePokemonMarker(f,e,b),e.marker.setMap(null),a[c].marker=f}})}function getPointDistance(a,b){return google.maps.geometry.spherical.computeDistanceBetween(a,b)}function sendNotification(a,b,c,d,e){if(!("Notification"in window))return!1;if("granted"!==Notification.permission)Notification.requestPermission();else{var f=new Notification(a,{icon:c,body:b,sound:"sounds/ding.mp3"});f.onclick=function(){window.focus(),f.close(),centerMap(d,e,20)}}}function createMyLocationButton(){var a=document.createElement("div"),b=document.createElement("button");b.style.backgroundColor="#fff",b.style.border="none",b.style.outline="none",b.style.width="28px",b.style.height="28px",b.style.borderRadius="2px",b.style.boxShadow="0 1px 4px rgba(0,0,0,0.3)",b.style.cursor="pointer",b.style.marginRight="10px",b.style.padding="0px",b.title="My Location",a.appendChild(b);var c=document.createElement("div");c.style.margin="5px",c.style.width="18px",c.style.height="18px",c.style.backgroundImage="url(static/mylocation-sprite-1x.png)",c.style.backgroundSize="180px 18px",c.style.backgroundPosition="0px 0px",c.style.backgroundRepeat="no-repeat",c.id="current-location",b.appendChild(c),b.addEventListener("click",function(){centerMapOnLocation()}),a.index=1,map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(a),google.maps.event.addListener(map,"dragend",function(){var a=document.getElementById("current-location");a.style.backgroundPosition="0px 0px"})}function centerMapOnLocation(){var a=document.getElementById("current-location"),b="0",c=setInterval(function(){b="-18"===b?"0":"-18",a.style.backgroundPosition=b+"px 0"},500);navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){var d=new google.maps.LatLng(b.coords.latitude,b.coords.longitude);locationMarker.setPosition(d),map.setCenter(d),Store.set("followMyLocationPosition",{lat:b.coords.latitude,lng:b.coords.longitude}),clearInterval(c),a.style.backgroundPosition="-144px 0px"}):(clearInterval(c),a.style.backgroundPosition="0px 0px")}function changeLocation(a,b){var c=new google.maps.LatLng(a,b);changeSearchLocation(a,b).done(function(){map.setCenter(c),searchMarker.setPosition(c)})}function changeSearchLocation(a,b){return $.post("next_loc?lat="+a+"&lon="+b,{})}function centerMap(a,b,c){var d=new google.maps.LatLng(a,b);map.setCenter(d),c&&(storeZoom=!1,map.setZoom(c))}function i8ln(a){return $.isEmptyObject(i8lnDictionary)&&"en"!==language&&languageLookups<languageLookupThreshold&&$.ajax({url:"static/dist/locales/"+language+".min.json",dataType:"json",async:!1,success:function a(b){i8lnDictionary=b},error:function a(b,c,d){console.log("Error loading i8ln dictionary: "+d),languageLookups++}}),a in i8lnDictionary?i8lnDictionary[a]:a}function updateGeoLocation(){navigator.geolocation&&(Store.get("geoLocate")||Store.get("followMyLocation"))&&navigator.geolocation.getCurrentPosition(function(a){var b=a.coords.latitude,c=a.coords.longitude,d=new google.maps.LatLng(b,c);Store.get("geoLocate")&&"undefined"!=typeof searchMarker&&getPointDistance(searchMarker.getPosition(),d)>40&&$.post("next_loc?lat="+b+"&lon="+c).done(function(){map.panTo(d),searchMarker.setPosition(d)}),Store.get("followMyLocation")&&"undefined"!=typeof locationMarker&&getPointDistance(locationMarker.getPosition(),d)>=5&&(map.panTo(d),locationMarker.setPosition(d),Store.set("followMyLocationPosition",{lat:b,lng:c}))})}function createUpdateWorker(){try{if(isMobileDevice()&&window.Worker){var a=new Blob(["onmessage = function(e) {\n        var data = e.data\n        if (data.name === 'backgroundUpdate') {\n          self.setInterval(function () {self.postMessage({name: 'backgroundUpdate'})}, 5000)\n        }\n      }"]),b=window.URL.createObjectURL(a);updateWorker=new Worker(b),updateWorker.onmessage=function(a){var b=a.data;document.hidden&&"backgroundUpdate"===b.name&&Date.now()-lastUpdateTime>2500&&(updateMap(),updateGeoLocation())},updateWorker.postMessage({name:"backgroundUpdate"})}}catch(a){console.log("Webworker error: "+a.message)}}var $selectExclude,$selectPokemonNotify,$selectRarityNotify,$textPerfectionNotify,$selectStyle,$selectIconResolution,$selectIconSize,$selectLuredPokestopsOnly,$selectSearchIconMarker,$selectGymMarkerStyle,$selectLocationIconMarker,language=""===document.documentElement.lang?"en":document.documentElement.lang,idToPokemon={},i8lnDictionary={},languageLookups=0,languageLookupThreshold=3,searchMarkerStyles,timestamp,excludedPokemon=[],notifiedPokemon=[],notifiedRarity=[],notifiedMinPerfection=null,buffer=[],reincludedPokemon=[],reids=[],map,rawDataIsLoading=!1,locationMarker,rangeMarkers=["pokemon","pokestop","gym"],searchMarker,storeZoom=!0,scanPath,moves,oSwLat,oSwLng,oNeLat,oNeLng,lastpokestops,lastgyms,lastpokemon,lastslocs,lastspawns,selectedStyle="light",updateWorker,lastUpdateTime,gymTypes=["Uncontested","Mystic","Valor","Instinct"],gymPrestige=[2e3,4e3,8e3,12e3,16e3,2e4,3e4,4e4,5e4],audio=new Audio("static/sounds/ding.mp3"),searchControlURI="search_control",updateLabelDiffTime=function a(){$(".label-countdown").each(function(a,b){var c=new Date(parseInt(b.getAttribute("disappears-at"))),d=new Date,e=Math.abs(c-d),f=Math.floor(e/36e5),g=Math.floor((e-36e5*f)/6e4),h=Math.floor((e-36e5*f-6e4*g)/1e3),i="";c<d?i="(expired)":(i="(",f>0&&(i=f+"h"),i+=("0"+g).slice(-2)+"m",i+=("0"+h).slice(-2)+"s",i+=")"),$(b).text(i)})};$(function(){return Notification?void("granted"!==Notification.permission&&Notification.requestPermission()):void console.log("could not load notifications")}),$(function(){$selectStyle=$("#map-style"),$.getJSON("static/dist/data/mapstyle.min.json").done(function(a){var b=[];$.each(a,function(a,c){b.push({id:a,text:i8ln(c)})}),$selectStyle.select2({placeholder:"Select Style",data:b,minimumResultsForSearch:1/0}),$selectStyle.on("change",function(a){selectedStyle=$selectStyle.val(),map.setMapTypeId(selectedStyle),Store.set("map_style",selectedStyle)}),$selectStyle.val(Store.get("map_style")).trigger("change")}),$selectIconResolution=$("#pokemon-icons"),$selectIconResolution.select2({placeholder:"Select Icon Resolution",minimumResultsForSearch:1/0}),$selectIconResolution.on("change",function(){Store.set("pokemonIcons",this.value),redrawPokemon(mapData.pokemons),redrawPokemon(mapData.lurePokemons)}),$selectIconSize=$("#pokemon-icon-size"),$selectIconSize.select2({placeholder:"Select Icon Size",minimumResultsForSearch:1/0}),$selectIconSize.on("change",function(){Store.set("iconSizeModifier",this.value),redrawPokemon(mapData.pokemons),redrawPokemon(mapData.lurePokemons)}),$selectLuredPokestopsOnly=$("#lured-pokestops-only-switch"),$selectLuredPokestopsOnly.select2({placeholder:"Only Show Lured Pokestops",minimumResultsForSearch:1/0}),$selectLuredPokestopsOnly.on("change",function(){Store.set("showLuredPokestopsOnly",this.value),lastpokestops=!1,updateMap()}),$selectSearchIconMarker=$("#iconmarker-style"),$selectLocationIconMarker=$("#locationmarker-style"),$.getJSON("static/dist/data/searchmarkerstyle.min.json").done(function(a){searchMarkerStyles=a;var b=[];$.each(a,function(a,c){b.push({id:a,text:c.name})}),$selectSearchIconMarker.select2({placeholder:"Select Icon Marker",data:b,minimumResultsForSearch:1/0}),$selectSearchIconMarker.on("change",function(a){var b=$selectSearchIconMarker.val();Store.set("searchMarkerStyle",b),updateSearchMarker(b)}),$selectSearchIconMarker.val(Store.get("searchMarkerStyle")).trigger("change"),updateSearchMarker(Store.get("lockMarker")),$selectLocationIconMarker.select2({placeholder:"Select Location Marker",data:b,minimumResultsForSearch:1/0}),$selectLocationIconMarker.on("change",function(a){Store.set("locationMarkerStyle",this.value),updateLocationMarker(this.value)}),$selectLocationIconMarker.val(Store.get("locationMarkerStyle")).trigger("change");
}),$selectGymMarkerStyle=$("#gym-marker-style"),$selectGymMarkerStyle.select2({placeholder:"Select Style",minimumResultsForSearch:1/0}),$selectGymMarkerStyle.on("change",function(a){Store.set("gymMarkerStyle",this.value),updateGymIcons()}),$selectGymMarkerStyle.val(Store.get("gymMarkerStyle")).trigger("change")}),$(function(){function a(a){if(!a.id)return a.text;var b=$('<span><i class="pokemon-sprite n'+a.element.value.toString()+'"></i> '+a.text+"</span>");return b}function b(a,b,c){return function(){Store.set(c,this.checked),this.checked?("showPokemon"===c?lastpokemon=!1:"showGyms"===c?lastgyms=!1:"showPokestops"===c?lastpokestops=!1:"showScanned"===c?lastslocs=!1:"showSpawnpoints"===c&&(lastspawns=!1),updateMap()):($.each(b,function(b,d){$.each(a[d],function(b,e){a[d][b].marker.rangeCircle&&(a[d][b].marker.rangeCircle.setMap(null),delete a[d][b].marker.rangeCircle),"showRanges"!==c&&a[d][b].marker.setMap(null)}),"showRanges"!==c&&(a[d]={})}),"showRanges"===c&&updateMap())}}Store.get("startAtUserLocation")&&centerMapOnLocation(),$.getJSON("static/dist/data/moves.min.json").done(function(a){moves=a}),$selectExclude=$("#exclude-pokemon"),$selectPokemonNotify=$("#notify-pokemon"),$selectRarityNotify=$("#notify-rarity"),$textPerfectionNotify=$("#notify-perfection");var c=151;$.getJSON("static/dist/data/pokemon.min.json").done(function(b){var d=[];$.each(b,function(a,b){if(a>c)return!1;var e=[];d.push({id:a,text:i8ln(b.name)+" - #"+a}),b.name=i8ln(b.name),b.rarity=i8ln(b.rarity),$.each(b.types,function(a,b){e.push({type:i8ln(b.type),color:b.color})}),b.types=e,idToPokemon[a]=b}),$selectExclude.select2({placeholder:i8ln("Select Pokémon"),data:d,templateResult:a}),$selectPokemonNotify.select2({placeholder:i8ln("Select Pokémon"),data:d,templateResult:a}),$selectRarityNotify.select2({placeholder:i8ln("Select Rarity"),data:[i8ln("Common"),i8ln("Uncommon"),i8ln("Rare"),i8ln("Very Rare"),i8ln("Ultra Rare")],templateResult:a}),$selectExclude.on("change",function(a){buffer=excludedPokemon,excludedPokemon=$selectExclude.val().map(Number),buffer=buffer.filter(function(a){return this.indexOf(a)<0},excludedPokemon),reincludedPokemon=reincludedPokemon.concat(buffer),clearStaleMarkers(),Store.set("remember_select_exclude",excludedPokemon)}),$selectPokemonNotify.on("change",function(a){notifiedPokemon=$selectPokemonNotify.val().map(Number),Store.set("remember_select_notify",notifiedPokemon)}),$selectRarityNotify.on("change",function(a){notifiedRarity=$selectRarityNotify.val().map(String),Store.set("remember_select_rarity_notify",notifiedRarity)}),$textPerfectionNotify.on("change",function(a){notifiedMinPerfection=parseInt($textPerfectionNotify.val(),10),(isNaN(notifiedMinPerfection)||notifiedMinPerfection<=0)&&(notifiedMinPerfection=""),notifiedMinPerfection>100&&(notifiedMinPerfection=100),$textPerfectionNotify.val(notifiedMinPerfection),Store.set("remember_text_perfection_notify",notifiedMinPerfection)}),$selectExclude.val(Store.get("remember_select_exclude")).trigger("change"),$selectPokemonNotify.val(Store.get("remember_select_notify")).trigger("change"),$selectRarityNotify.val(Store.get("remember_select_rarity_notify")).trigger("change"),$textPerfectionNotify.val(Store.get("remember_text_perfection_notify")).trigger("change"),isTouchDevice()&&isMobileDevice()&&$(".select2-search input").prop("readonly",!0)}),window.setInterval(updateLabelDiffTime,1e3),window.setInterval(updateMap,5e3),window.setInterval(updateGeoLocation,1e3),createUpdateWorker(),$("#gyms-switch").change(function(){b(mapData,["gyms"],"showGyms").bind(this)()}),$("#pokemon-switch").change(function(){b(mapData,["pokemons"],"showPokemon").bind(this)()}),$("#scanned-switch").change(function(){b(mapData,["scanned"],"showScanned").bind(this)()}),$("#spawnpoints-switch").change(function(){b(mapData,["spawnpoints"],"showSpawnpoints").bind(this)()}),$("#ranges-switch").change(b(mapData,["gyms","pokemons","pokestops"],"showRanges")),$("#pokestops-switch").change(function(){var a={duration:500},c=$("#lured-pokestops-only-wrapper");return this.checked?(lastpokestops=!1,c.show(a)):(lastpokestops=!1,c.hide(a)),b(mapData,["pokestops"],"showPokestops").bind(this)()}),$("#sound-switch").change(function(){Store.set("playSound",this.checked)}),$("#geoloc-switch").change(function(){$("#next-location").prop("disabled",this.checked),$("#next-location").css("background-color",this.checked?"#e0e0e0":"#ffffff"),navigator.geolocation?Store.set("geoLocate",this.checked):this.checked=!1}),$("#lock-marker-switch").change(function(){Store.set("lockMarker",this.checked),searchMarker.setDraggable(!this.checked)}),$("#search-switch").change(function(){searchControl(this.checked?"on":"off")}),$("#start-at-user-location-switch").change(function(){Store.set("startAtUserLocation",this.checked)}),$("#follow-my-location-switch").change(function(){navigator.geolocation?Store.set("followMyLocation",this.checked):this.checked=!1,locationMarker.setDraggable(!this.checked)}),$("#scan-here-switch").change(function(){this.checked&&!Store.get("scanHereAlerted")&&(alert("Use this feature carefully ! This button will set the current map center as new search location. This may cause worker to teleport long range."),Store.set("scanHereAlerted",!0)),$("#scan-here").toggle(this.checked),Store.set("scanHere",this.checked)}),$("#nav-accordion").length&&$("#nav-accordion").accordion({active:0,collapsible:!0,heightStyle:"content"}),$("#pokemonList_table").DataTable({paging:!1,searching:!1,info:!1,errMode:"throw",language:{emptyTable:""},columns:[{orderable:!1},null,null,null]}).order([1,"asc"])});
//# sourceMappingURL=map.min.js.map